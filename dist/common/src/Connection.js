var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:true});exports.default=void 0;var _classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));var _createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass"));var _EventHandler=_interopRequireDefault(require("./services/EventHandler"));var _constants=require("./constants");var _helpers=require("./helpers");var WebSocketClass=typeof WebSocket!=='undefined'?WebSocket:null;var WS_STATE={CONNECTING:0,OPEN:1,CLOSING:2,CLOSED:3};var MESSAGE_TIMEOUT=10000;var Connection=function(){function Connection(options){(0,_classCallCheck2.default)(this,Connection);var sessionId=options.sessionId,wssUrl=options.wssUrl;this.sessionId=sessionId;this.wssUrl=wssUrl;this._messesageTimer={};this._messageQueue=[];this._resendMessageQueue=this._resendMessageQueue.bind(this);}(0,_createClass2.default)(Connection,[{key:"connect",value:function connect(){var _this=this;if(!WebSocketClass){console.error('WebSocket not supported in your browser/platform');return;}try{this._wsClient=new WebSocketClass(this.wssUrl);}catch(e){_EventHandler.default.emit(_constants.SocketEvent.ON_ERROR,e,null,this.sessionId);}this._wsClient.onopen=function(event){_EventHandler.default.emit(_constants.SocketEvent.ON_OPEN,null,event,_this.sessionId);_this._resendMessageQueue();};this._wsClient.onclose=function(event){console.log('[SocketConnection] Closed');_EventHandler.default.emit(_constants.SocketEvent.ON_CLOSE,null,event,_this.sessionId);};this._wsClient.onerror=function(event){return _EventHandler.default.emit(_constants.SocketEvent.ON_ERROR,event,null,_this.sessionId);};this._wsClient.onmessage=function(event){var msgObj=(0,_helpers.parseJSON)(event.data);if(!msgObj){_this._handleSpeedMessage(event.data);return;}if(!msgObj.id||!_EventHandler.default.emit(msgObj.id,null,msgObj,_this.sessionId)){_EventHandler.default.emit(_constants.SocketEvent.ON_MESSAGE,null,msgObj,_this.sessionId);}};}},{key:"close",value:function close(){if(this._wsClient&&this.isAlive){this._wsClient.close();}this._wsClient=null;}},{key:"send",value:function send(message){var _this2=this;if(!this.isConnected){return new Promise(function(resolve,reject){_this2._messageQueue.push({resolve:resolve,message:message});});}return new Promise(function(resolve,reject){if(typeof message==='string'){_this2._wsClient.send(message);return resolve(true);}else if(typeof message==='object'){if(!message.id){message.id=(0,_helpers.generateUUID)();}_EventHandler.default.subscribeOnce(message.id,function(err,data){if(err){return reject(err);}var _this2$_parseMessageR=_this2._parseMessageResult(data),error=_this2$_parseMessageR.error,result=_this2$_parseMessageR.result;if(error){if(typeof error!=='object'){return reject(new Error(error.toString()));}return reject(error);}return resolve(result);},_this2.sessionId);_this2._setMessageTimer(message.id);_this2._wsClient.send(JSON.stringify(message));}else{reject('Message type not supported');}});}},{key:"_resendMessageQueue",value:function _resendMessageQueue(){console.debug("[SocketConnection] Resend "+this._messageQueue.length+" messages in queue.");while(this._messageQueue.length>0){var _this$_messageQueue$s=this._messageQueue.shift(),resolve=_this$_messageQueue$s.resolve,message=_this$_messageQueue$s.message;resolve(this.send(message));}}},{key:"_setMessageTimer",value:function _setMessageTimer(id){var _this3=this;this._messesageTimer[id]=setTimeout(function(){_EventHandler.default.emit(id,new Error("Message "+id+" timeout"),null,_this3.sessionId);_this3._removeMessageTimer(id);},MESSAGE_TIMEOUT);}},{key:"_removeMessageTimer",value:function _removeMessageTimer(id){if(this._messesageTimer[id]){clearTimeout(this._messesageTimer[id]);delete this._messesageTimer[id];}}},{key:"testSpeed",value:function testSpeed(bytes){this.send('#SPU '+bytes);var loops=bytes/1024;if(bytes%1024){loops=loops+1;}var data=new Array(1024).join('.');for(var i=0;i<loops;i++){this.send('#SPB '+data);}this.send('#SPE');}},{key:"_handleSpeedMessage",value:function _handleSpeedMessage(message){if(message&&message.length>4&&message.startsWith('#SP')){switch(message[3]){case'U':this._upDur=parseInt(message.substring(4));break;case'D':this._downDur=parseInt(message.substring(4));_EventHandler.default.emit(_constants.SocketEvent.ON_SPEED_CHANGE,null,{upDur:this._upDur,downDur:this._downDur},this.sessionId);break;}}else{console.warn('Unknown message',message);}}},{key:"_parseMessageResult",value:function _parseMessageResult(data){var error=data.error,result=data.result;if(error){return{error:error};}return{result:result};}},{key:"isConnected",get:function get(){return this._wsClient&&this._wsClient.readyState===WS_STATE.OPEN;}},{key:"isConnecting",get:function get(){return this._wsClient&&this._wsClient.readyState===WS_STATE.CONNECTING;}},{key:"isClosing",get:function get(){return this._wsClient&&this._wsClient.readyState===WS_STATE.CLOSING;}},{key:"isClosed",get:function get(){return this._wsClient&&this._wsClient.readyState===WS_STATE.CLOSED;}},{key:"isAlive",get:function get(){return this.isConnecting||this.isConnected;}},{key:"isDead",get:function get(){return this.isClosing||this.isClosed;}}]);return Connection;}();var _default=Connection;exports.default=_default;