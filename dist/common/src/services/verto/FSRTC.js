var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:true});exports.default=void 0;var _extends2=_interopRequireDefault(require("@babel/runtime/helpers/extends"));var _classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));var _createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass"));var _webrtc=require("../webrtc");var _constants=require("../../constants");var _helpers=require("./helpers");var defaultPeerConfig={sdpSemantics:'plan-b',bundlePolicy:'max-compat',iceServers:[{urls:['stun:stun.l.google.com:19302']}]};var FSRTC=function(){(0,_createClass2.default)(FSRTC,[{key:"peerType",get:function get(){return this._options.peerType;}}]);function FSRTC(options){var _this=this;(0,_classCallCheck2.default)(this,FSRTC);this.peer=null;this._peerConfig=defaultPeerConfig;this._callbacks={onICESdpError:null,onICESdpDescription:null,onLocalStream:null,onRemoteStream:null,onRemoteStreamEnded:null,onUserMediaError:null};this._iceDone=false;this._iceTimeout=null;this._iceRetries=1;this._needNegotiation=true;this._options=(0,_extends2.default)({},options);if(options.iceServers&&Array.isArray(options.iceServers)){this._peerConfig.iceServers=options.iceServers;}this._callbacks=(0,_extends2.default)({},this._callbacks,options.callbacks);this._mediaConstraints={audio:options.useAudio,video:options.useVideo};this._offerConstraints={offerToReceiveAudio:!this._options.screenShare,offerToReceiveVideo:!this._options.screenShare};this._createPeerConnection=this._createPeerConnection.bind(this);this._addStreamToPeerConnection=this._addStreamToPeerConnection.bind(this);this._onICECandidateComplete=this._onICECandidateComplete.bind(this);this._startNegotiation=this._startNegotiation.bind(this);this.setLocalDescription=this.setLocalDescription.bind(this);this.setRemoteDescription=this.setRemoteDescription.bind(this);if(this._options.localStream){this._callbacks.onLocalStream&&this._callbacks.onLocalStream(this._options.localStream);this.peer=this._createPeerConnection();this._addStreamToPeerConnection(this._options.localStream);}else{(0,_webrtc.getUserMedia)(this._mediaConstraints).then(function(stream){_this._callbacks.onLocalStream&&_this._callbacks.onLocalStream(stream);_this.peer=_this._createPeerConnection();_this._addStreamToPeerConnection(stream);}).catch(function(ex){_this._callbacks.onUserMediaError&&_this._callbacks.onUserMediaError(ex);});}}(0,_createClass2.default)(FSRTC,[{key:"changeMediaConstraints",value:function changeMediaConstraints(mediaConstraints){var _this2=this;if(mediaConstraints.useAudio===this._mediaConstraints.audio&&mediaConstraints.useVideo===this._mediaConstraints.video){return;}this._mediaConstraints={audio:mediaConstraints.useAudio||this._mediaConstraints.audio,video:mediaConstraints.useVideo};(0,_webrtc.getUserMedia)(this._mediaConstraints).then(function(stream){_this2._callbacks.onLocalStream&&_this2._callbacks.onLocalStream(stream);_this2._replaceLocalStream(stream);}).catch(function(ex){_this2._callbacks.onUserMediaError&&_this2._callbacks.onUserMediaError(ex);});}},{key:"close",value:function close(){if(this.peer){this.peer.close();}}},{key:"_createPeerConnection",value:function _createPeerConnection(){var _this3=this;var peer=new _webrtc.RTCPeerConnection(this._peerConfig);peer.onicecandidate=function(event){if(_this3._iceDone){return;}if(!_this3._iceTimeout){_this3._iceTimeout=setTimeout(function(){return _this3._onICECandidateComplete(_this3.peer.localDescription);},1000);}if(event.candidate){console.log('[Peer] onicecandidate:',event.candidate);}else{console.log('[Peer] onicecandidate finished');_this3._onICECandidateComplete(_this3.peer.localDescription);}};peer.ontrack=function(event){console.log('[Peer] ontrack');var remoteStream=event.streams[0];remoteStream.oninactive=function(){_this3._callbacks.onRemoteStreamEnded&&_this3._callbacks.onRemoteStreamEnded(remoteStream);};_this3._callbacks.onRemoteStream(remoteStream);};peer.onaddstream=function(event){console.log('[Peer] onaddstream');var remoteStream=event.stream;remoteStream.oninactive=function(){_this3._callbacks.onRemoteStreamEnded&&_this3._callbacks.onRemoteStreamEnded(remoteStream);};_this3._callbacks.onRemoteStream(remoteStream);};peer.onsignalingstatechange=function(event){console.log('[Peer] onsignalingstatechange',_this3.peer.signalingState);switch(_this3.peer.signalingState){case'stable':_this3._needNegotiation=true;break;case'have-local-offer':case'have-remote-offer':case'have-local-pranswer':case'have-remote-pranswer':_this3._needNegotiation=false;break;case'closed':break;default:break;}};peer.onconnectionstatechange=function(event){console.log('[Peer] onconnectionstatechange',_this3.peer.connectionState);switch(_this3.peer.connectionState){case'closed':break;case'connected':case'disconnected':case'failed':default:break;}};peer.onnegotiationneeded=function(event){console.log('[Peer] onnegotiationneeded');if(!_this3._needNegotiation){return;}_this3._startNegotiation();};return peer;}},{key:"_addStreamToPeerConnection",value:function _addStreamToPeerConnection(stream){var _this4=this;if(this.peer.addTrack){stream.getAudioTracks().forEach(function(track){_this4.peer.addTrack(track,stream);});stream.getVideoTracks().forEach(function(track){_this4.peer.addTrack(track,stream);});}else if(this.peer.addStream){this.peer.addStream(stream);}}},{key:"_replaceLocalStream",value:function _replaceLocalStream(stream){var videoTrack=stream.getVideoTracks().length>0?stream.getVideoTracks()[0]:null;var audioTrack=stream.getAudioTracks().length>0?stream.getAudioTracks()[0]:null;var senders=this.peer.getSenders();var videoSenders=senders.filter(function(sender){return sender.track.kind==='video';});var videoSender=videoSenders.length>0?videoSenders[0]:null;var audioSenders=senders.filter(function(sender){return sender.track.kind==='audio';});var audioSender=audioSenders.length>0?audioSenders[0]:null;if(videoTrack&&videoSender){videoSender.track.stop();videoSender.track.enabled=false;videoSender.replaceTrack(videoTrack);}else if(videoTrack){this.peer.addTrack(videoTrack);}else if(videoSender){videoSender.track.stop();videoSender.track.enabled=false;this.peer.removeTrack(videoSender);}if(audioTrack&&audioSender){audioSender.track.stop();audioSender.track.enabled=false;audioSender.replaceTrack(audioTrack);}else if(audioTrack){this.peer.addTrack(audioTrack);}}},{key:"_onICECandidateComplete",value:function _onICECandidateComplete(sdpDescription){console.log('[FSRTC] _onICECandidateComplete',sdpDescription);this._iceDone=true;if(this._iceTimeout){clearTimeout(this._iceTimeout);this._iceTimeout=null;}var sdp=sdpDescription.sdp;if(sdp.indexOf('candidate')<0){if(this._iceRetries<3){this._iceRetries++;this._startNegotiation();}else{this._callbacks.onICESdpError&&this._callbacks.onICESdpError(new Error('Cannot collect ICE candidates.'));}return;}this._callbacks.onICESdpDescription(sdpDescription);}},{key:"setLocalDescription",value:function setLocalDescription(rtcSessionDescription){var sdp=rtcSessionDescription.sdp;if(this._options.useStereo){sdp=(0,_helpers.sdpStereoHack)(sdp);rtcSessionDescription.sdp=sdp;}return this.peer.setLocalDescription(rtcSessionDescription);}},{key:"setRemoteDescription",value:function setRemoteDescription(rtcSessionDescription){var sdp=rtcSessionDescription.sdp;if(this._options.useStereo){sdp=(0,_helpers.sdpStereoHack)(sdp);rtcSessionDescription.sdp=sdp;}return this.peer.setRemoteDescription(rtcSessionDescription);}},{key:"_startNegotiation",value:function _startNegotiation(){var _this5=this;console.log('[FSRTC] Start NEGOTIATION');var self=this;this._needNegotiation=false;if(this.peerType===_constants.PeerType.OFFER){this.peer.createOffer(this._offerConstraints).then(this.setLocalDescription).then(function(){console.log('[FSRTC] Create Offer Done');if(self._iceRetries>1){self._onICECandidateComplete(self.peer.localDescription);}}).catch(function(ex){console.error('[FSRTC] Failed to create offer',ex);});}else{var sdp=this._options.sdp;this.setRemoteDescription({type:_constants.PeerType.OFFER,sdp:sdp}).then(function(){return _this5.peer.createAnswer();}).then(this.setLocalDescription).then(function(){console.log('[FSRTC] Create Answer Done');if(self._iceRetries>1){self._onICECandidateComplete(self.peer.localDescription);}}).catch(function(ex){console.error('[FSRTC] Failed to create answer',ex);});}}}]);return FSRTC;}();exports.default=FSRTC;